rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // 유효성 검증 함수들
    // ============================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidGold(gold) {
      return gold is number && gold >= 0 && gold <= 999999999;
    }

    function isValidLevel(level) {
      return level is number && level >= 0 && level <= 20;
    }

    function isValidStats(stats) {
      return stats is map
        && stats.attempts is number && stats.attempts >= 0
        && stats.successes is number && stats.successes >= 0
        && stats.failures is number && stats.failures >= 0
        && stats.maxLevel is number && stats.maxLevel >= 0 && stats.maxLevel <= 20;
    }

    // 골드 변화량 제한 (한 번에 최대 1억 변화 - 고강 판매 고려)
    function isReasonableGoldChange(before, after) {
      let diff = after - before;
      return diff >= -100000000 && diff <= 1000000000;
    }

    // ============================================
    // 사용자 데이터 - 인증 기반 보안
    // ============================================
    match /users/{userId} {
      // 읽기: 누구나 가능 (랭킹, 친구 조회용)
      allow read: if true;

      // 생성: Cloud Functions에서만 가능 (verifyKakaoToken)
      // 클라이언트에서 직접 생성 불가
      allow create: if false;

      // 업데이트: 본인만 가능 + 필드 검증
      allow update: if isOwner(userId) &&
        // 골드 검증
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['gold']) ||
          (isValidGold(request.resource.data.gold) &&
           isReasonableGoldChange(resource.data.gold, request.resource.data.gold))) &&
        // 레벨 검증
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['level']) ||
          isValidLevel(request.resource.data.level)) &&
        // 스탯 검증
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['stats']) ||
          isValidStats(request.resource.data.stats));

      // 삭제 금지
      allow delete: if false;
    }

    // ============================================
    // 관리용 컬렉션 - Cloud Functions에서만 쓰기 가능
    // ============================================

    // 레벨 이미지
    match /levelImages/{imageId} {
      allow read: if true;
      allow write: if false;
    }

    // 랭킹 (updateRanking 함수에서 업데이트)
    match /rankings/{rankId} {
      allow read: if true;
      allow write: if false;
    }

    // 강화 설정
    match /settings/{settingId} {
      allow read: if true;
      allow write: if false;
    }

    // ============================================
    // 알림 컬렉션 - 인증된 사용자만
    // ============================================

    // 배틀 알림
    match /battleNotifications/{notifId} {
      allow read: if isAuthenticated();

      // 생성: 인증된 사용자만, 필수 필드 검증
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['recipientId', 'attackerId', 'attackerName', 'attackerWon', 'timestamp']) &&
        request.resource.data.recipientId is string &&
        request.resource.data.attackerId == request.auth.uid; // 본인이 공격자여야 함

      // 읽음 처리: 수신자만 가능
      allow update: if isAuthenticated() &&
        resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      allow delete: if false;
    }

    // 선물 알림 - Cloud Functions에서만 생성 (secureSendGold)
    match /giftNotifications/{notifId} {
      allow read: if isAuthenticated();
      allow create: if false; // Cloud Function에서만

      // 읽음 처리: 수신자만
      allow update: if isAuthenticated() &&
        resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      allow delete: if false;
    }

    // 강화 알림 (푸시용)
    match /enhanceNotifications/{notifId} {
      allow read: if isAuthenticated();

      // 생성: 인증된 사용자가 본인 명의로만
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['senderId', 'senderName', 'level', 'tokens', 'timestamp']) &&
        request.resource.data.senderId == request.auth.uid &&
        request.resource.data.level is number &&
        request.resource.data.level >= 10;

      // 처리 완료 표시: Cloud Functions에서만
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // 강화 로그 (실시간 피드)
    // ============================================
    match /enhanceLogs/{logId} {
      allow read: if true; // 피드는 누구나 볼 수 있음

      // 생성: 인증된 사용자가 본인 명의로만
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['userId', 'nickname', 'timestamp']) &&
        request.resource.data.userId == request.auth.uid &&
        // 레벨 기반 로그는 10강 이상만
        (!request.resource.data.keys().hasAny(['level']) || request.resource.data.level >= 10) &&
        // 채팅은 100자 제한
        (!request.resource.data.keys().hasAny(['message']) || request.resource.data.message.size() <= 100);

      allow update: if false;
      allow delete: if false; // cleanupEnhanceLogs 함수에서만
    }
  }
}
